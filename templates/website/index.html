{% extends "website/base.html" %}

{% block page_header %}
<!-- <h2 class="page-head-title">Search</h2> -->
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-xs-12">
    <div class="panel panel-default">
      <div class="panel-body xs-pb-10">
        <form action="{% url 'search' %}" method="POST" class="form-horizontal" id="userPromptForm">
          {% csrf_token %}

          <label for="model">Select a language model: </label>
          <select id="model" name="model" disabled>
            <option>Loading models…</option>
          </select>
          <div id="status" class="hint"></div>

          <div class="form-group" style="margin-top: 12px;">
            <div class="input-group input-search">
              <input type="text" name="user_prompt" id="searchPromptInput"
                     oninput="document.getElementById('searchPromptButton').disabled = this.value === ''"
                     placeholder="Enter your question here..." class="form-control" required>
              <span class="input-group-btn">
                <button type="submit" class="btn btn-default" id="searchPromptButton" disabled>
                  <i class="icon mdi mdi-search"></i> Search
                </button>
              </span>
            </div>
          </div>
        </form>

        <script>
          async function loadModels() {
            const sel = document.getElementById('model');
            const status = document.getElementById('status');
            sel.innerHTML = '<option>Loading models…</option>';
            sel.disabled = true;

            try {
              const res = await fetch('/api/ollama/models/');
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Failed to fetch models');

              const models = data.models || [];
              if (models.length === 0) {
                sel.innerHTML = '<option value="">No models found</option>';
                status.className = 'error';
                status.textContent = 'No models found. Is Ollama running? Try `ollama serve` and `ollama pull <model>`.';
                return;
              }
              sel.innerHTML = models.map(n => `<option value="${n}">${n}</option>`).join('');
              sel.disabled = false; // important: enabled so it gets submitted
              status.className = 'ok';
              {#status.textContent = `Loaded ${models.length} model(s).`;#}
            } catch (e) {
              sel.innerHTML = '<option value="">Error loading models</option>';
              status.className = 'error';
              status.textContent = 'Could not reach Ollama. Check your Docker compose and OLLAMA_BASE_URL.';
            }
          }
          loadModels();
        </script>
      </div>
    </div>
  </div>
</div>
{% endblock %}