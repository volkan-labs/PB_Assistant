{% load static %}

<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>PB Assistant</title>
    <script src="{% static '/website/assets/lib/jquery/jquery.min.js' %}" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e2732",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.375rem", // Bootstrap rounded-md approx
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111418;
        }

        ::-webkit-scrollbar-thumb {
            background: #283039;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3b4754;
        }
    </style>

    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script type="text/javascript">
        $(document).ready(function () {


            $('#userPromptForm').submit(function () {
                $.blockUI({
                    message: `<div class="custom-blockui">
                            <div class="spinner"></div>
                            <h1>Loading, please wait...</h1>
                        </div>`,
                    css: {
                        border: 'none',
                        backgroundColor: 'transparent',
                        padding: '0'
                    }
                });
            });

            loadModels();
            loadPromptHistory();
        });

        async function loadModels() {
            const ollamaModelsDropdown = $('#ollamaModels');
            ollamaModelsDropdown.html('<option>Loading models…</option>');
            ollamaModelsDropdown.prop('disabled', true);

            try {
                const res = await fetch('/api/ollama/models/');
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to fetch models');

                const models = data.models || [];
                if (models.length === 0) {
                    alert('No models found. Is Ollama running? Try `ollama serve` and `ollama pull <model>`.');
                    return;
                }
                ollamaModelsDropdown.html(models.map(n => `<option value="${n}">${n}</option>`).join(''));
                ollamaModelsDropdown.prop('disabled', false); // important: enabled so it gets submitted
            } catch (e) {
                ollamaModelsDropdown.html('<option value="">Error loading models</option>');
                alert('Could not reach Ollama. Check your Docker compose and OLLAMA_BASE_URL.');
            }
        }


        function deletePrompt(promptId) {
            $.ajax({
                url: '/delete-history/' + promptId,
                type: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken },
                mode: 'same-origin', // Do not send CSRF token to another domain.
                success: function (response) {
                    $('#userPromptHistory li').slice(1).remove();

                    loadPromptHistory();
                },
                error: function (xhr, status, error) {
                    alert('Failed to delete the resource.');
                    console.error('Error:', error);
                }
            });
        }


        function loadPromptHistory() {
            $.getJSON('/history/', function (historyItems) {

                if (!jQuery.isEmptyObject(historyItems)) {
                    $.each(historyItems, function (index, value) {
                        $('#userPromptHistory').append(
                            `
                        <div
                            class="group flex items-center justify-between rounded-lg pl-3 pr-2 transition-colors hover:bg-slate-100 dark:hover:bg-slate-800/50">
                            <a href="/history-item/${value.id}" class="flex flex-1 items-center gap-3 py-3 text-left min-w-0">
                                <span
                                    class="material-symbols-outlined text-slate-400 text-[20px] group-hover:text-slate-600 dark:group-hover:text-slate-300 shrink-0">history</span>
                                <span
                                    class="truncate text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">${formatTitle(value.title)}</span>
                            </a>
                            <button aria-label="Remove item" onclick="deletePrompt(${value.id})"
                                class="flex h-8 w-8 shrink-0 items-center justify-center rounded-md text-slate-400 opacity-0 group-hover:opacity-100 hover:bg-slate-200 hover:text-slate-700 dark:hover:bg-slate-700 dark:hover:text-slate-200 transition-all focus:opacity-100 focus:outline-none">
                                <span class="material-symbols-outlined text-[18px]">close</span>
                            </button>
                        </div>
                        `
                        );
                    });

                } else {
                    $('#userPromptHistory').hide();
                }
            });
        }

        function formatTitle(title) {
            if (title.length > 18) {
                return title.substr(0, 15) + '...';
            }
            return title;
        }
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-white overflow-hidden h-screen flex">
    <div class="flex h-screen w-full flex-row">
        <!-- Sidebar -->
        <aside class="w-[280px] bg-surface-dark border-r border-[#283039] flex flex-col h-full shrink-0 max-md:hidden">
            <!-- Sidebar Header / Branding -->
            <div class="flex items-center gap-3 px-6 py-5 border-b border-slate-100 dark:border-slate-800/50">
                <img src="pb-assistant-cupola2.png" alt="Logo" class="h-20" />
            </div>
            <!-- Sidebar Content -->
            <div class="flex flex-1 flex-col overflow-y-auto px-4 py-6">
                <!-- Section: History -->
                <div class="flex flex-col gap-4">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Recent
                            Searches</h3>
                        <button class="text-xs font-medium text-primary hover:text-primary/80">Clear</button>
                    </div>
                    <div class="flex flex-col gap-1">
                        <!-- Active Item -->
                        <!-- <div
                            class="group flex items-center justify-between rounded-lg bg-primary/10 pl-3 pr-2 transition-colors hover:bg-primary/20">
                            <button class="flex flex-1 items-center gap-3 py-3 text-left min-w-0">
                                <span class="material-symbols-outlined text-primary text-[20px] shrink-0">history</span>
                                <span class="truncate text-sm font-medium text-primary">Designing for
                                    Accessibility</span>
                            </button>
                            <button aria-label="Remove item"
                                class="flex h-8 w-8 shrink-0 items-center justify-center rounded-md text-primary/60 hover:bg-primary/20 hover:text-primary transition-colors focus:opacity-100 focus:outline-none">
                                <span class="material-symbols-outlined text-[18px]">close</span>
                            </button>
                        </div> -->
                    </div>
                </div>
            </div>
        </aside>
        <!-- Main Content Area -->
        <main class="flex flex-1 flex-col relative h-full">
            <!-- Top Navigation (Minimal) -->
            <header class="flex w-full items-center justify-between px-8 py-5">
                <!-- Mobile Menu Trigger (Hidden on Desktop) -->
                <button
                    class="lg:hidden rounded-lg p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </header>
            <!-- Center Content -->
            <div class="flex flex-1 flex-col items-center justify-center px-4 pb-20">
                {% block content %}{% endblock %}
            </div>
            <!-- Footer Links -->
            <footer class="flex justify-center gap-6 py-6 text-sm text-slate-500 dark:text-slate-500">
                <a class="hover:text-slate-800 dark:hover:text-slate-300" href="https://github.com/ozgeozge">Özge Kart
                    Tokmak @ PIK Potsdam</a>
            </footer>
        </main>
    </div>
</body>

</html>