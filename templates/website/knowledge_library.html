{% extends 'website/base.html' %}
{% load static %}

{% block content %}
<div class="w-full">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Knowledge Library</h1>
    <p class="text-lg text-gray-600 dark:text-gray-300 mb-6">Manage your research documents</p>
    
    {% if documents %}
    <div class="bg-white dark:bg-surface-dark shadow-md rounded-lg overflow-hidden" id="document-table-container">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-surface-highlight">
            <thead class="bg-amber-100 dark:bg-amber-900">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                        File Name
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                        Size
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                        Uploaded At
                    </th>
                    <th scope="col" class="relative px-6 py-3 text-xs font-medium text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                        <span class="sr-only">Delete</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-surface-dark divide-y divide-gray-200 dark:divide-surface-highlight">
                {% for doc in documents %}
                <tr id="doc-{{ forloop.counter }}" class="odd:bg-gray-50 dark:odd:bg-surface-highlight">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white max-w-xs truncate">
                        {{ doc.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-text-secondary">
                        {{ doc.size|filesizeformat }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-text-secondary">
                        {{ doc.timestamp|date:"Y-m-d H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-filename="{{ doc.name }}" data-row-id="doc-{{ forloop.counter }}" class="delete-doc-btn text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="flex flex-col items-center justify-center p-8 text-center text-sm text-slate-500 dark:text-slate-400" id="document-table-container">
        <span class="material-symbols-outlined text-slate-400 text-[64px] opacity-50 mb-4">description</span>
        <p class="font-medium text-lg">Your library is feeling a bit lonely...</p>
        <p class="text-md mt-2">Upload your research documents to build your personal knowledge hub!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block body_end %}
<script>
$(document).ready(function() {
    const emptyMessageHtml = `
        <div class="flex flex-col items-center justify-center p-8 text-center text-sm text-slate-500 dark:text-slate-400" id="document-table-container">
            <span class="material-symbols-outlined text-slate-400 text-[64px] opacity-50 mb-4">description</span>
            <p class="font-medium text-lg">Your library is feeling a bit lonely...</p>
            <p class="text-md mt-2">Upload your research documents to build your personal knowledge hub!</p>
        </div>
    `;

    $('.delete-doc-btn').on('click', function() {
        const btn = $(this);
        const filename = btn.data('filename');
        const rowId = btn.data('row-id');
        const tableBody = btn.closest('tbody');
        const documentTableContainer = $('#document-table-container'); // Get the container div
        
        showConfirmationModal(
            'Delete Document',
            `Are you sure you want to delete "${filename}"? This action cannot be undone.`,
            'Delete',
            function() {
                $.ajax({
                    url: "{% url 'delete_document' %}",
                    type: 'DELETE',
                    headers: { 'X-CSRFToken': csrftoken },
                    contentType: 'application/json',
                    data: JSON.stringify({ filename: filename }),
                    success: function() {
                        $('#' + rowId).remove();
                        
                        // Check if the table body is now empty
                        if (tableBody.find('tr').length === 0) {
                            documentTableContainer.replaceWith(emptyMessageHtml); // Replace the table container with the empty message
                        }
                    },
                    error: function() {
                        showError('Failed to delete the document.');
                    }
                });
            }
        );
    });
});
</script>
{% endblock %}