{% load static %}

<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Earth System Science AI Assistant</title>
    {% include "website/partials/head_common_scripts.html" %}
    {% include "website/partials/material_symbols.html" with include_fill_variant=True %}
    {% include "website/partials/tailwind_config.html" %}
    {% include "website/partials/theme_init_script.html" %}
    <link href="{% static 'website/assets/css/base.css' %}" rel="stylesheet" />

    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script src="{% static 'website/assets/js/main.utils.js' %}?v={% now "U" %}" type="text/javascript"></script>
    <script src="{% static 'website/assets/js/main.models.js' %}?v={% now "U" %}" type="text/javascript"></script>
    <script src="{% static 'website/assets/js/main.history.js' %}?v={% now "U" %}" type="text/javascript"></script>
    <script src="{% static 'website/assets/js/main.ui.js' %}?v={% now "U" %}" type="text/javascript"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 flex" {% block body_attributes %}{% endblock %}>
    <div class="flex w-full flex-row">
        <aside class="w-[280px] bg-white dark:bg-surface-dark border-r border-gray-200 dark:border-[#283039] flex flex-col h-screen shrink-0 max-md:hidden sticky top-0 relative z-[1000] transform">
            <!-- Sidebar Header / Branding -->
            <div class="flex items-center gap-3 px-6 py-5 border-b border-slate-100 dark:border-slate-800/50">
                <a href="/" class="flex items-center gap-3">
                    <img src="{% static '/website/assets/images/ess-ai-logo.png' %}" alt="Logo" class="h-20" />
                </a>
            </div>
            <!-- Sticky new search button -->
            
            {% block new_search_button_area %}{% endblock %}
            
            {% include "website/partials/sidebar_left_content.html" %}
        </aside>
        <!-- Main Content Area -->
        <main class="flex flex-1 flex-col relative h-full">
            <!-- Error Toast -->
            {% include "website/partials/error_toast.html" with toast_class="hidden absolute top-4 right-4 z-50 bg-red-600 text-white p-4 rounded-lg shadow-lg" %}

            <!-- Top Navigation (Minimal) -->
            <header class="flex w-full items-center justify-between px-8 py-5">
                <!-- Mobile Menu Trigger (Hidden on Desktop) -->
                <button
                    class="lg:hidden rounded-lg p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <nav class="flex items-center space-x-4">
                    <a href="{% url 'knowledge_library' %}" 
                       class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium 
                              text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-surface-highlight 
                              hover:text-primary transition-colors">
                        <span class="material-symbols-outlined text-base">library_books</span>
                        Knowledge Library
                    </a>
                </nav>
                <!-- Theme Toggle -->
                {% include "website/partials/theme_toggle.html" with wrapper_class="relative flex items-center bg-[#f3f4f6] dark:bg-[#1a2230] rounded-full p-1 border border-[#e5e7eb] dark:border-[#2a3447] h-10" %}
            </header>
            <!-- Center Content -->
            <div class="flex flex-1 flex-col items-center px-4">
                {% block content %}{% endblock %}
            </div>
            <!-- Recommended Publications -->
            <!-- <div id="recommended-publications-list" class="mt-4 w-full px-4">
                <div class="mx-auto w-full max-w-3xl mb-4">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h3 class="flex items-center gap-2 text-xs font-semibold text-slate-500 tracking-wider">
                            <span class="material-symbols-outlined text-sm">recommend</span>
                            Recommended Papers
                        </h3>
                        <a href="{% url 'search' %}?filter=recommended"
                           class="text-[11px] font-semibold text-primary hover:text-primary/80 transition-colors inline-flex items-center gap-1">
                            View all
                            <span class="material-symbols-outlined text-[14px]">arrow_forward</span>
                        </a>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3 pb-2 -mx-1 px-1 w-full max-w-[46rem] mx-auto">
                        <div
                            class="snap-start flex shrink-0 w-[14.5rem] flex-col gap-2 rounded-lg border border-slate-200 dark:border-[#2d3b55] bg-white dark:bg-[#151b26] p-3 hover:bg-slate-50 dark:hover:bg-[#1e293b] hover:border-slate-300 dark:hover:border-slate-500 cursor-pointer transition-all group shadow-sm">
                            <div class="flex items-start gap-3">
                                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded bg-red-500/10 text-red-500">
                                    <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
                                </div>
                                <p
                                    class="text-xs font-medium text-slate-700 dark:text-slate-300 line-clamp-2 leading-relaxed group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                    Safe and just Earth system boundaries
                                </p>
                            </div>
                            <div class="mt-auto pt-1">
                                <span
                                    class="inline-flex items-center rounded-md bg-orange-500/10 px-2 py-0.5 text-[10px] font-medium text-orange-500 dark:text-orange-400 ring-1 ring-inset ring-orange-500/20">
                                    Climate Change
                                </span>
                            </div>
                        </div>
                        <div
                            class="snap-start flex shrink-0 w-[14.5rem] flex-col gap-2 rounded-lg border border-slate-200 dark:border-[#2d3b55] bg-white dark:bg-[#151b26] p-3 hover:bg-slate-50 dark:hover:bg-[#1e293b] hover:border-slate-300 dark:hover:border-slate-500 cursor-pointer transition-all group shadow-sm">
                            <div class="flex items-start gap-3">
                                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded bg-red-500/10 text-red-500">
                                    <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
                                </div>
                                <p
                                    class="text-xs font-medium text-slate-700 dark:text-slate-300 line-clamp-2 leading-relaxed group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                    A planetary boundary for green water
                                </p>
                            </div>
                            <div class="mt-auto pt-1">
                                <span
                                    class="inline-flex items-center rounded-md bg-blue-500/10 px-2 py-0.5 text-[10px] font-medium text-blue-500 dark:text-blue-400 ring-1 ring-inset ring-blue-500/20">
                                    Freshwater Change
                                </span>
                            </div>
                        </div>
                        <div
                            class="snap-start flex shrink-0 w-[14.5rem] flex-col gap-2 rounded-lg border border-slate-200 dark:border-[#2d3b55] bg-white dark:bg-[#151b26] p-3 hover:bg-slate-50 dark:hover:bg-[#1e293b] hover:border-slate-300 dark:hover:border-slate-500 cursor-pointer transition-all group shadow-sm">
                            <div class="flex items-start gap-3">
                                <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded bg-red-500/10 text-red-500">
                                    <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
                                </div>
                                <p
                                    class="text-xs font-medium text-slate-700 dark:text-slate-300 line-clamp-2 leading-relaxed group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                    Outside the Safe Operating Space of the Planetary Boundary
                                </p>
                            </div>
                            <div class="mt-auto pt-1">
                                <span
                                    class="inline-flex items-center rounded-md bg-purple-500/10 px-2 py-0.5 text-[10px] font-medium text-purple-500 dark:text-purple-400 ring-1 ring-inset ring-purple-500/20">
                                    Novel Entities
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
            <!-- Footer Links -->
            <footer class="flex flex-col items-center justify-center py-6 text-[10px] text-slate-500 dark:text-slate-500">
                <p>&copy; <span id="copyright-year">2025</span> Earth System Science AI Assistant. All rights reserved.</p>
                <p class="mt-2">Developed by <a class="hover:text-slate-800 dark:hover:text-slate-300" href="https://github.com/ozgeozge/PB_Assistant" target="_blank" rel="noopener noreferrer">PB Science Lab</a> @ <a class="text-primary hover:text-primary/80 transition-colors" href="https://www.pik-potsdam.de/en" target="_blank" rel="noopener noreferrer">The Potsdam Institute for Climate Impact Research (PIK)</a></p>
            </footer>
        </main>

        <aside class="w-[280px] bg-white dark:bg-surface-dark border-r border-gray-200 dark:border-[#283039] flex flex-col h-screen shrink-0 max-md:hidden sticky top-0">
            {% include "website/partials/sidebar_right_content.html" %}
        </aside>
    </div>

    <!-- Confirmation Modal -->
    {% include "website/partials/confirmation_modal.html" with modal_class="fixed inset-0 z-[4000] hidden" %}

    <!-- New Folder Modal -->
    {% include "website/partials/new_folder_modal.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% include "website/partials/loading_overlay.html" with overlay_class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[5000] flex items-center justify-center hidden" %}
{% include "website/partials/theme_toggle_script.html" %}
<script>
    $(document).ready(function() {
        const list = $('#latest-publications-list');
        list.html('<li class="text-xs text-text-secondary">Loading publications...</li>'); // Loading indicator

        fetch("{% url 'rss_feed' %}")
            .then(response => response.json())
            .then(data => {
                list.empty();
                if (data.error) {
                    throw new Error(data.error);
                }
                if (data.length === 0) {
                    const settingsUrl = "{% url 'settings' %}";
                    list.html('<li class="text-xs text-text-secondary">No publications found. <br> <a href="' + settingsUrl + '" class="text-primary hover:text-primary/80 transition-colors">Configure RSS feeds in settings.</a></li>');
                } else {
                    data.forEach(item => {
                        const metaParts = [];
                        if (item.date) {
                            metaParts.push(item.date);
                        }
                        if (item.source) {
                            metaParts.push(item.source);
                        }
                        const metaLine = metaParts.length ? `<p class="text-[11px] text-text-secondary mt-1">${metaParts.join(' Â· ')}</p>` : '';
                        const listItem = `
                            <li class="mb-4">
                                <a href="${item.link}" target="_blank" class="text-sm text-primary hover:text-primary/80 transition-colors">${item.title}</a>
                                ${metaLine}
                                <p class="text-xs text-text-secondary">${item.description}</p>
                            </li>
                        `;
                        list.append(listItem);
                    });
                }
            })
            .catch(err => {
                console.error('Failed to load RSS feed:', err);
                list.html('<li class="text-xs text-text-secondary">Failed to load publications.</li>');
            });
    });
</script>
{% block body_end %}{% endblock %}
</body>

</html>
