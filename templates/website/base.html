{% load static %}

<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>PB Assistant</title>
    <script src="{% static '/website/assets/lib/jquery/jquery.min.js' %}" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-dark": "#111418",
                        "surface-highlight": "#283039",
                        "text-secondary": "#9dabb9",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.375rem", // Bootstrap rounded-md approx
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111418;
        }

        ::-webkit-scrollbar-thumb {
            background: #283039;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3b4754;
        }

        /* BlockUI custom styles */
        /* Styling for the loading prompt */
        .custom-blockui {
            text-align: center;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        .custom-blockui h1 {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid transparent;
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Optional background styling */
        .blockUI.blockOverlay {
            background-color: rgba(0, 0, 0, 0.8) !important;
        }
    </style>

    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script type="text/javascript">
        $(document).ready(function () {

            $('#userPromptForm').submit(function () {
                $.blockUI({
                    message: `<div class="custom-blockui">
                            <div class="spinner"></div>
                            <h1>Loading, please wait...</h1>
                        </div>`,
                    css: {
                        border: 'none',
                        backgroundColor: 'transparent',
                        padding: '0'
                    }
                });
            });

            $('#clearButton').click(function () {
                showConfirmationModal(
                    'Clear All History',
                    'Are you sure you want to delete all search history? This action cannot be undone.',
                    'Delete All',
                    function () {
                        $.ajax({
                            url: '/history/clear/',
                            type: 'DELETE',
                            headers: { 'X-CSRFToken': csrftoken },
                            success: function () {
                                window.location.href = "/";
                            },
                            error: function (xhr, status, error) {
                                alert('Failed to clear history.');
                                console.error('Error:', error);
                            }
                        });
                    }
                );
            });

            loadModels();

            $('#newSearchButton').click(function () {
                window.location.href = "/";
            });

            // Modal cancel button
            $('#modalCancelButton').click(function() {
                $('#confirmationModal').addClass('hidden');
            });
        });

        $(window).on('load', function () {
            loadPromptHistory();
        });

        function showConfirmationModal(title, body, confirmText, onConfirm) {
            $('#modalTitle').text(title);
            $('#modalBody').text(body);
            $('#modalConfirmButton').text(confirmText);

            // Use .off() to prevent multiple handlers from being attached
            $('#modalConfirmButton').off('click').on('click', function() {
                onConfirm();
                $('#confirmationModal').addClass('hidden');
            });

            $('#confirmationModal').removeClass('hidden');
        }

        async function loadModels() {
            const ollamaModelsDropdown = $('#ollamaModels');
            ollamaModelsDropdown.html('<option>Loading models…</option>');
            ollamaModelsDropdown.prop('disabled', true);

            try {
                const res = await fetch('/api/ollama/models/');
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to fetch models');

                const models = data.models || [];
                if (models.length === 0) {
                    alert('No models found. Is Ollama running? Try `ollama serve` and `ollama pull <model>`.');
                    return;
                }
                ollamaModelsDropdown.html(models.map(n => `<option value="${n}">${n}</option>`).join(''));
                ollamaModelsDropdown.prop('disabled', false); // important: enabled so it gets submitted
            } catch (e) {
                ollamaModelsDropdown.html('<option value="">Error loading models</option>');
                alert('Could not reach Ollama. Check your Docker compose and OLLAMA_BASE_URL.');
            }
        }


        function deletePrompt(promptId) {
            showConfirmationModal(
                'Delete Search Item',
                'Are you sure you want to delete this item? This action cannot be undone.',
                'Delete Item',
                function() {
                    const activeHistoryId = parseInt($('body').attr('data-history-id'), 10);
                    $.ajax({
                        url: '/delete-history/' + promptId,
                        type: 'DELETE',
                        headers: { 'X-CSRFToken': csrftoken },
                        mode: 'same-origin',
                        success: function (response) {
                            if (promptId === activeHistoryId) {
                                window.location.href = "/";
                            } else {
                                loadPromptHistory();
                            }
                        },
                        error: function (xhr, status, error) {
                            alert('Failed to delete the resource.');
                            console.error('Error:', error);
                        }
                    });
                }
            );
        }


        function loadPromptHistory() {
            const activeHistoryId = parseInt($('body').attr('data-history-id'), 10);
            $.getJSON('/history/', function (historyItems) {

                if (!jQuery.isEmptyObject(historyItems)) {
                    $('#userPromptHistory').empty();
                    $.each(historyItems, function (index, value) {
                        $('#emptyHistory').hide();
                        $('#clearButton').show();

                        const isActive = value.id === activeHistoryId;
                        let classes = "group flex items-center justify-between rounded-lg pl-3 pr-2 transition-colors";
                        if (isActive) {
                            classes += " bg-primary/20"; // Active state class
                        } else {
                            classes += " hover:bg-slate-100 dark:hover:bg-slate-800/50"; // Non-active hover state
                        }


                        $('#userPromptHistory').append(
                            `
                        <div class="${classes}">
                            <a href="/history-item/${value.id}" class="flex flex-1 items-center gap-3 py-3 text-left min-w-0">
                                <span
                                    class="material-symbols-outlined text-slate-400 text-[20px] group-hover:text-slate-600 dark:group-hover:text-slate-300 shrink-0">history</span>
                                <span
                                    class="truncate text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">${formatTitle(value.title)}</span>
                            </a>
                            <button aria-label="Remove item" onclick="deletePrompt(${value.id})"
                                class="flex h-8 w-8 shrink-0 items-center justify-center rounded-md text-slate-400 opacity-0 group-hover:opacity-100 hover:bg-slate-200 hover:text-slate-700 dark:hover:bg-slate-700 dark:hover:text-slate-200 transition-all focus:opacity-100 focus:outline-none">
                                <span class="material-symbols-outlined text-[18px]">close</span>
                            </button>
                        </div>
                        `
                        );
                    });

                } else {
                    $('#userPromptHistory').hide();
                    $('#emptyHistory').show();
                    $('#clearButton').hide();
                }
            });
        }

        function formatTitle(title) {
            if (title.length > 18) {
                return title.substr(0, 15) + '...';
            }
            return title;
        }
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-white overflow-hidden h-screen flex" {% block body_attributes %}{% endblock %}>
    <div class="flex h-screen w-full flex-row">
        <!-- Sidebar -->
        <aside class="w-[280px] bg-surface-dark border-r border-[#283039] flex flex-col h-full shrink-0 max-md:hidden">
            <!-- Sidebar Header / Branding -->
            <div class="flex items-center gap-3 px-6 py-5 border-b border-slate-100 dark:border-slate-800/50">
                <a href="/" class="flex items-center gap-3">
                    <img src="{% static '/website/assets/images/pb-assistant-logo.png' %}" alt="Logo" class="h-20" />
                </a>
            </div>
            <!-- Sidebar Content -->
            <div class="flex flex-1 flex-col overflow-y-auto px-4 py-6">
                {% block new_search_button_area %}{% endblock %}
                <!-- Section: History -->
                <div class="flex flex-col gap-4">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Recent
                            Searches</h3> <button class="text-xs font-medium text-primary hover:text-primary/80"
                            id="clearButton">Clear</button>
                    </div>
                    <div class="flex flex-col gap-1" id="userPromptHistory">
                        <div id="emptyHistory"
                            class="group flex items-center justify-between rounded-lg bg-primary/10 pl-3 pr-2 transition-colors hover:bg-primary/20">
                            <!-- ... empty history svg ... -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <!-- Main Content Area -->
        <main class="flex flex-1 flex-col relative h-full">
            <!-- Top Navigation (Minimal) -->
            <header class="flex w-full items-center justify-between px-8 py-5">
                <!-- Mobile Menu Trigger (Hidden on Desktop) -->
                <button
                    class="lg:hidden rounded-lg p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </header>
            <!-- Center Content -->
            <div class="flex flex-1 flex-col items-center justify-center px-4 pb-20">
                {% block content %}{% endblock %}
            </div>
            <!-- Footer Links -->
            <footer class="flex justify-center gap-6 py-6 text-sm text-slate-500 dark:text-slate-500">
                <a class="hover:text-slate-800 dark:hover:text-slate-300" href="https://github.com/ozgeozge">Özge Kart
                    Tokmak @ PIK Potsdam</a>
            </footer>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" aria-labelledby="modal-title" aria-modal="true" class="relative z-50 hidden" role="dialog">
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-xl bg-surface-dark border border-[#3b4754] text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="p-6">
                        <div class="flex items-start gap-4">
                            <div
                                class="flex-shrink-0 flex items-center justify-center size-10 rounded-full bg-red-500/10">
                                <span class="material-symbols-outlined text-red-500">warning</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white leading-6" id="modalTitle">Delete Item</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-text-secondary leading-relaxed" id="modalBody">
                                        Are you sure you want to delete this? This action cannot be undone.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex flex-col sm:flex-row-reverse gap-3">
                            <button id="modalConfirmButton"
                                class="inline-flex w-full justify-center rounded-lg bg-red-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto transition-colors"
                                type="button">
                                Confirm
                            </button>
                            <button id="modalCancelButton"
                                class="inline-flex w-full justify-center rounded-lg bg-transparent px-4 py-2.5 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-[#3b4754] hover:bg-[#3b4754] sm:w-auto transition-colors"
                                type="button">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
